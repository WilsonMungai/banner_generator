<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js"
        type="text/javascript"></script>
    <title>Cruise Countdown Generator</title>
</head>

<body style="margin: 0; background-color: #000; color: #fff;">
    <canvas id="bannerCanvas" width="430" height="630"></canvas>
</body>

<script>
    const canvas = document.getElementById("bannerCanvas");
    const ctx = canvas.getContext("2d");

    let cloudUrl = "";
    let formData = new FormData();

    async function drawBanner(data) {
        const { cruiseName, destination, sailDate, days, hours, mins, imageUrl, eventName, logoUrl } = data;

        const userImage = new Image();
        userImage.crossOrigin = "anonymous";
        userImage.src = imageUrl;

        return new Promise((resolve) => {
            userImage.onload = () => {
                // Background
                ctx.fillStyle = "#FF2DAE";
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                const targetWidth = canvas.width;
                const targetHeight = 262;

                const aspectRatio = userImage.width / userImage.height;
                const targetRatio = targetWidth / targetHeight;

                let srcWidth, srcHeight, srcX, srcY;

                if (aspectRatio > targetRatio) {
                    // Image is wider than target — crop horizontally
                    srcHeight = userImage.height;
                    srcWidth = userImage.height * targetRatio;
                    srcX = (userImage.width - srcWidth) / 2;
                    srcY = 0;
                } else {
                    // Image is taller — crop vertically
                    srcWidth = userImage.width;
                    srcHeight = userImage.width / targetRatio;
                    srcX = 0;
                    srcY = (userImage.height - srcHeight) / 2;
                }

                // Draw the cropped image
                ctx.drawImage(
                    userImage,
                    srcX,
                    srcY,
                    srcWidth,
                    srcHeight,
                    0,
                    0,
                    targetWidth,
                    targetHeight
                );

                // === Blue Container ===
                const containerY = imgY + imgHeight + 10;
                const containerPadding = 20;
                const lineHeight = 30;
                const numLines = 3;
                const containerHeight = containerPadding * 2 + lineHeight * numLines;

                ctx.fillStyle = "#00FFFF";
                ctx.fillRect(0, containerY, canvas.width, containerHeight);

                // Borders
                ctx.strokeStyle = "black";
                ctx.lineWidth = 0.5;
                ctx.beginPath();
                ctx.moveTo(0, containerY);
                ctx.lineTo(canvas.width, containerY);
                ctx.moveTo(0, containerY + containerHeight);
                ctx.lineTo(canvas.width, containerY + containerHeight);
                ctx.stroke();

                // Blue container text
                ctx.fillStyle = "#000";
                ctx.textAlign = "center";
                ctx.font = "bold 16px sans-serif";

                const centerX = canvas.width / 2;
                const textYStart = containerY + containerPadding + lineHeight / 2;

                ctx.fillText(cruiseName.toUpperCase(), centerX, textYStart);
                ctx.fillText("DESTINATION: " + destination.toUpperCase(), centerX, textYStart + lineHeight);
                ctx.fillText("SAILING ON: " + sailDate.toUpperCase(), centerX, textYStart + 2 * lineHeight);

                // === Event Name Below Blue Container ===
                const eventY = containerY + containerHeight + 40;
                ctx.fillStyle = "#fff";
                ctx.textAlign = "center";
                ctx.font = "bold 20px sans-serif";
                ctx.fillText(eventName.toUpperCase(), canvas.width / 2, eventY);

                // === Logo Image Below Event Name ===
                const logoImage = new Image();
                logoImage.crossOrigin = "anonymous";
                logoImage.src = logoUrl;

                logoImage.onload = () => {
                    const logoWidth = 400;
                    const logoHeight = 100;
                    const logoX = (canvas.width - logoWidth) / 2;
                    const logoY = eventY + 30;

                    ctx.drawImage(logoImage, logoX, logoY, logoWidth, logoHeight);

                    // === Countdown Below Logo ===
                    const countdownY = logoY + logoHeight + 60;
                    ctx.fillStyle = "#fff";
                    ctx.textAlign = "left";
                    ctx.font = "bold 100px monospace";
                    ctx.fillText(`${days}d ${hours}h ${mins}m`, 50, countdownY);

                    resolve();
                };

                logoImage.onerror = () => {
                    console.error("Logo image failed to load.");
                    const fallbackY = eventY + 80;
                    const countdownY = fallbackY + 100;

                    ctx.fillStyle = "#fff";
                    ctx.textAlign = "left";
                    ctx.font = "bold 100px monospace";
                    ctx.fillText(`${days}d ${hours}h ${mins}m`, 50, countdownY);

                    resolve();
                };
            };

            userImage.onerror = () => {
                console.error("Main image failed to load.");
                ctx.fillStyle = "#FF2DAE";
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = "#fff";
                ctx.font = "bold 60px sans-serif";
                ctx.fillText(cruiseName.toUpperCase(), 50, 100);
                ctx.font = "40px sans-serif";
                ctx.fillText("DESTINATION: " + destination.toUpperCase(), 50, 180);
                ctx.fillText("SAILING ON: " + sailDate.toUpperCase(), 50, 250);
                ctx.font = "bold 100px monospace";
                ctx.fillText(`${days}d ${hours}h ${mins}m`, 50, 400);

                resolve();
            };
        });
    }

    function uploadToCloudinary() {
        return new Promise((resolve, reject) => {
            canvas.toBlob(async (blob) => {
                formData.set("file", blob);
                try {
                    const response = await fetch(cloudUrl, {
                        method: "POST",
                        body: formData,
                    });
                    const result = await response.json();
                    if (result.secure_url) {
                        resolve(result.secure_url);
                    } else {
                        reject(result.error.message);
                    }
                } catch (error) {
                    reject(error.message);
                }
            }, "image/png");
        });
    }

    ThunkableWebviewerExtension.receiveMessage(async (message) => {
        try {
            const data = JSON.parse(message);

            if (data.type === "setKey") {
                const { cloudName, apiKey, preset } = data;
                cloudUrl = `https://api.cloudinary.com/v1_1/${cloudName}/upload`;
                formData.append("upload_preset", preset);
                formData.append("api_key", apiKey);
            }

            if (data.type === "trip") {
                ThunkableWebviewerExtension.postMessage(JSON.stringify({ type: "drawing" }));
                await drawBanner(data);

                ThunkableWebviewerExtension.postMessage(JSON.stringify({ type: "uploading" }));
                const imageUrl = await uploadToCloudinary();

                ThunkableWebviewerExtension.postMessage(
                    JSON.stringify({ type: "image", url: imageUrl })
                );
            }
        } catch (error) {
            ThunkableWebviewerExtension.postMessage(
                JSON.stringify({ type: "error", message: error.toString() })
            );
        }
    });

    ThunkableWebviewerExtension.postMessage(
        JSON.stringify({ type: "page loaded" })
    );
</script>

</html>