<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js"
    type="text/javascript"></script>
  <title>Cruise Countdown Generator</title>
</head>

<body style="margin: 0; background-color: #000; color: #fff;">
  <canvas id="bannerCanvas" width="430" height="630"></canvas>
</body>

<script>
  const canvas = document.getElementById("bannerCanvas");
  const ctx = canvas.getContext("2d");

  let cloudUrl = "";
  let formData = new FormData();

  async function drawBanner(data) {
    const { cruiseName, destination, sailDate, days, hours, mins, imageUrl, eventName, logoUrl } = data;

    const userImage = new Image();
    userImage.crossOrigin = "anonymous";
    userImage.src = imageUrl;

    return new Promise((resolve) => {
      userImage.onload = () => {
        // Draw background image to fill canvas
        ctx.drawImage(userImage, 0, 0, canvas.width, canvas.height);

        // === Blue Container ===
        const containerPadding = 10;
        const lineHeight = 22;
        const numLines = 3;
        const containerHeight = containerPadding * 2 + lineHeight * numLines;
        const containerY = 10;

        ctx.fillStyle = "#00FFFF";
        ctx.fillRect(0, containerY, canvas.width, containerHeight);

        // Borders
        ctx.strokeStyle = "black";
        ctx.lineWidth = 0.5;
        ctx.beginPath();
        ctx.moveTo(0, containerY);
        ctx.lineTo(canvas.width, containerY);
        ctx.moveTo(0, containerY + containerHeight);
        ctx.lineTo(canvas.width, containerY + containerHeight);
        ctx.stroke();

        // Blue container text
        ctx.fillStyle = "#000";
        ctx.textAlign = "center";
        ctx.font = "bold 16px sans-serif";

        const centerX = canvas.width / 2;
        const textYStart = containerY + containerPadding + lineHeight / 2;

        ctx.fillText(cruiseName.toUpperCase(), centerX, textYStart);
        ctx.fillText("DESTINATION: " + destination.toUpperCase(), centerX, textYStart + lineHeight);
        ctx.fillText("SAILING ON: " + sailDate.toUpperCase(), centerX, textYStart + 2 * lineHeight);

        // === Event Name ===
        const eventY = containerY + containerHeight + 20;
        ctx.fillStyle = "#fff";
        ctx.textAlign = "center";
        ctx.font = "bold 20px sans-serif";
        ctx.fillText(eventName.toUpperCase(), canvas.width / 2, eventY);

        // === Logo Image ===
        const logoImage = new Image();
        logoImage.crossOrigin = "anonymous";
        logoImage.src = logoUrl;

        logoImage.onload = () => {
          const logoHeight = 50;
          const logoWidth = 200;
          const logoX = (canvas.width - logoWidth) / 2;
          const logoY = eventY + 20;

          ctx.drawImage(logoImage, logoX, logoY, logoWidth, logoHeight);

          // === Countdown ===
          const countdownY = logoY + logoHeight + 40;
          ctx.fillStyle = "#fff";
          ctx.textAlign = "left";
          ctx.font = "bold 40px monospace";
          ctx.fillText(`${days}d ${hours}h ${mins}m`, 20, countdownY);

          resolve();
        };

        logoImage.onerror = () => {
          console.error("Logo failed to load.");
          const fallbackY = eventY + 60;
          const countdownY = fallbackY + 40;

          ctx.fillStyle = "#fff";
          ctx.textAlign = "left";
          ctx.font = "bold 40px monospace";
          ctx.fillText(`${days}d ${hours}h ${mins}m`, 20, countdownY);

          resolve();
        };
      };

      userImage.onerror = () => {
        console.error("Main image failed to load.");
        ctx.fillStyle = "#FF2DAE";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = "#fff";
        ctx.font = "bold 20px sans-serif";
        ctx.fillText(cruiseName.toUpperCase(), 20, 100);
        ctx.font = "16px sans-serif";
        ctx.fillText("DESTINATION: " + destination.toUpperCase(), 20, 140);
        ctx.fillText("SAILING ON: " + sailDate.toUpperCase(), 20, 170);
        ctx.font = "bold 40px monospace";
        ctx.fillText(`${days}d ${hours}h ${mins}m`, 20, 250);

        resolve();
      };
    });
  }

  function uploadToCloudinary() {
    return new Promise((resolve, reject) => {
      canvas.toBlob(async (blob) => {
        formData.set("file", blob);
        try {
          const response = await fetch(cloudUrl, {
            method: "POST",
            body: formData,
          });
          const result = await response.json();
          if (result.secure_url) {
            resolve(result.secure_url);
          } else {
            reject(result.error.message);
          }
        } catch (error) {
          reject(error.message);
        }
      }, "image/png");
    });
  }

  ThunkableWebviewerExtension.receiveMessage(async (message) => {
    try {
      const data = JSON.parse(message);

      if (data.type === "setKey") {
        const { cloudName, apiKey, preset } = data;
        cloudUrl = `https://api.cloudinary.com/v1_1/${cloudName}/upload`;
        formData.append("upload_preset", preset);
        formData.append("api_key", apiKey);
      }

      if (data.type === "trip") {
        ThunkableWebviewerExtension.postMessage(JSON.stringify({ type: "drawing" }));
        await drawBanner(data);

        ThunkableWebviewerExtension.postMessage(JSON.stringify({ type: "uploading" }));
        const imageUrl = await uploadToCloudinary();

        ThunkableWebviewerExtension.postMessage(
          JSON.stringify({ type: "image", url: imageUrl })
        );
      }
    } catch (error) {
      ThunkableWebviewerExtension.postMessage(
        JSON.stringify({ type: "error", message: error.toString() })
      );
    }
  });

  ThunkableWebviewerExtension.postMessage(
    JSON.stringify({ type: "page loaded" })
  );
</script>

</html>